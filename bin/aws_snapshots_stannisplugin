#!/usr/bin/env ruby

$:.unshift(File.expand_path("../../lib", __FILE__))
require "aws_snapshots_stannisplugin"
require "optparse"

options = {}
opts = OptionParser.new do |opts|
  opts.banner = "Usage: aws_snapshots_stannisplugin [options]"

  opts.on("-c", "--config CONFIG", "Path to configuration file") do |c|
    options[:config] = c
  end

  opts.separator ""
  opts.separator "Common options:"
  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
  opts.on("--version", "Show version") do |v|
    puts "aws_snapshots_stannisplugin #{Stannis::Plugin::AwsSnapshots::VERSION}"
    exit 0
  end
end

opts.parse!(ARGV)
unless options[:config]
  puts opts
  exit 1
end

config = Stannis::Plugin::AwsSnapshots::Config.load_file(options[:config])
collector = Stannis::Plugin::AwsSnapshots::Collector.new(config)

puts collector.fetch_statuses.to_json
